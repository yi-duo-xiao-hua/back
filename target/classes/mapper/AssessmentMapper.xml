<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.hello.mapper.AssessmentMapper">

    <!-- 结果映射 -->
    <resultMap id="AssessmentResultMap" type="com.example.hello.entity.Assessment">
        <id column="assessment_id" property="assessmentId"/>
        <result column="patient_id" property="patientId"/>
        <result column="scale_id" property="scaleId"/>
        <result column="total_score" property="totalScore"/>
        <result column="assessment_result" property="assessmentResult"/>
        <result column="depression_score" property="depressionScore"/>
        <result column="schizophrenia_score" property="schizophreniaScore"/>
        <result column="anxiety_score" property="anxietyScore"/>
        <result column="insomnia_score" property="insomniaScore"/>
        <result column="obsessive_score" property="obsessiveScore"/>
        <result column="assessment_date" property="assessmentDate"/>
        <result column="answers" property="answers" jdbcType="VARCHAR"/>
        <result column="recommendation" property="recommendation"/>
        <result column="scale_name" property="scaleName"/>
    </resultMap>

    <!-- 根据患者ID查询所有评估记录 -->
    <select id="selectByPatientId" resultMap="AssessmentResultMap">
        SELECT
            a.assessment_id,
            a.patient_id,
            a.scale_id,
            a.total_score,
            a.assessment_result,
            a.depression_score,
            a.schizophrenia_score,
            a.anxiety_score,
            a.insomnia_score,
            a.obsessive_score,
            a.assessment_date,
            a.answers,
            a.recommendation,
            s.name AS scale_name
        FROM assessments a
        LEFT JOIN scales s ON a.scale_id = s.scale_id
        WHERE a.patient_id = #{patientId}
        ORDER BY a.assessment_date DESC
    </select>

    <!-- 根据评估记录ID查询详情 -->
    <select id="selectByAssessmentId" resultMap="AssessmentResultMap">
        SELECT
            a.assessment_id,
            a.patient_id,
            a.scale_id,
            a.total_score,
            a.assessment_result,
            a.depression_score,
            a.schizophrenia_score,
            a.anxiety_score,
            a.insomnia_score,
            a.obsessive_score,
            a.assessment_date,
            a.answers,
            a.recommendation,
            s.name AS scale_name
        FROM assessments a
        LEFT JOIN scales s ON a.scale_id = s.scale_id
        WHERE a.assessment_id = #{assessmentId}
    </select>

    <insert id="insertAssessment" parameterType="com.example.hello.entity.Assessment"
            useGeneratedKeys="true" keyProperty="assessmentId">
        INSERT INTO assessments
        (
        patient_id,
        scale_id,
        total_score,
        assessment_result,
        depression_score,
        schizophrenia_score,
        anxiety_score,
        insomnia_score,
        obsessive_score,
        answers,
        recommendation
        )
        VALUES
        (
        #{patientId},
        #{scaleId},
        #{totalScore},
        #{assessmentResult},
        #{depressionScore},
        #{schizophreniaScore},
        #{anxietyScore},
        #{insomniaScore},
        #{obsessiveScore},
        #{answers,jdbcType=LONGVARCHAR},
        #{recommendation}
        )
    </insert>

</mapper>

