<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.hello.mapper.PatientMapper">

    <!-- 结果映射 -->
    <resultMap id="PatientResultMap" type="com.example.hello.entity.Patient">
        <id column="patient_id" property="patientId"/>
        <result column="user_id" property="userId"/>
        <result column="name" property="name"/>
        <result column="gender" property="gender"/>
        <result column="birth_date" property="birthDate"/>
        <result column="id_card" property="idCard"/>
        <result column="medical_history_remark" property="medicalHistoryRemark"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 根据用户ID查询患者信息 -->
    <select id="selectByUserId" resultMap="PatientResultMap">
        SELECT
            patient_id,
            user_id,
            name,
            gender,
            birth_date,
            id_card,
            medical_history_remark,
            create_time,
            update_time
        FROM patients
        WHERE user_id = #{userId}
    </select>

    <!-- 根据患者ID查询患者信息 -->
    <select id="selectByPatientId" resultMap="PatientResultMap">
        SELECT
            patient_id,
            user_id,
            name,
            gender,
            birth_date,
            id_card,
            medical_history_remark,
            create_time,
            update_time
        FROM patients
        WHERE patient_id = #{patientId}
    </select>

    <!-- 更新患者信息 -->
    <update id="updatePatient" parameterType="com.example.hello.entity.Patient">
        UPDATE patients
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="gender != null">gender = #{gender},</if>
            <if test="birthDate != null">birth_date = #{birthDate},</if>
            <if test="idCard != null and idCard != ''">id_card = #{idCard},</if>
            <if test="medicalHistoryRemark != null">medical_history_remark = #{medicalHistoryRemark},</if>
        </set>
        WHERE patient_id = #{patientId}
    </update>

    <!-- 检查患者是否存在 -->
    <select id="checkPatientExists" resultType="int">
        SELECT COUNT(1) FROM patients WHERE patient_id = #{patientId}
    </select>

    <!-- 新增患者 -->
    <insert id="insertPatient" parameterType="com.example.hello.entity.Patient" useGeneratedKeys="true"
            keyProperty="patientId">
        INSERT INTO patients (
            user_id,
            name,
            gender,
            birth_date,
            id_card,
            medical_history_remark
        ) VALUES (
            #{userId},
            #{name},
            #{gender},
            #{birthDate},
            #{idCard},
            #{medicalHistoryRemark}
        )
    </insert>

    <!-- 根据身份证统计数量 -->
    <select id="countByIdCard" resultType="int">
        SELECT COUNT(1) FROM patients WHERE id_card = #{idCard}
    </select>

</mapper>

